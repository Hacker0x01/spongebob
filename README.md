# Spongebob
## A tool to run and diff nmap runs

Spongebob is a collection of scripts to:
* discover internet-facing networks and hosts based on a configuration file and querying AWS accounts in all regions. NOTE: currently (5/1/14) some regions are blacklisted due to generating errors accessing them (us-gov-west-1, cn-north-1).
* run nmap scans against these IP addresses
* provide different reports: changes since last run, changes since last day and last week, and an open ports report

## Files
* spongebob.py: the main script and library. When run as a script, it will generate a list of hosts from 'config.json' and by iterating through AWS accounts defined there.
* reporter.py: reports on diff to previous run, last day, or last week
* openports.py: generates an overall open ports report

## Requirements
* Nmap version 6.4 or higher (for ipv6)
* boto (python AWS library). Note, must be a recent version (install from pip).
* python 2.7+ (not 3.x)
* nmap scans need to be run as root, so either run spongebob from root or set up sudo correctly for the account running spongebob.

## Command line
### spongebob.py
```ShellSession
./spongebob.py --help
Usage: spongebob.py [options]

Options:
  -h, --help            show this help message and exit
  -c FILE, --config=FILE
                        Specify configuration FILE path. Default is
                        ./config.json
```

### reporter.py
```ShellSession
Usage: reporter.py [options]

Options:
  -h, --help            show this help message and exit
  -c FILE, --config=FILE
                        Specify configuration FILE path. Default ./config.json
  -d DIFFTIME, --diff=DIFFTIME
                        Diff timescale, either "day", "week", or "previous"
                        (default)
  --showfiltered        Show ports in "filtered" state
```

## Implementation
### spongebob.py

See spongebob.html (generated with 'pydoc -w spongebob.py') for functions.
#### Flow
1. read configuration file.
	* default ./config.json, command line option --config to change
2. generate list of networks from config.json
3. generate list of public IP addresses in AWS based on account credentials in config.json
4. write the networks dict into a JSON-formatted cache file since AWS lookup takes a fair amount of time.
5. use multiprocessing module to run multiple parallel nmap scans, with XML output
6. combine the separate nmap XML reports into a single XML document and save this file for use in reporting with ndiff.

### reporter.py
See reporter.html (generated with 'pydoc -w reporter.py') for functions.
#### Flow
1. if default diff requested, read two of the latest scan reports and produce a diff
2. if a time-based diff is requested (--diff day|week), find a scan report approximately day or week ago, and diff with the latest scan
3. read cache file generated by spongebob.py and use the dict as a lookup table to correctly tag the IP addresses with a description string or owning AWS account.
4. use ndiff.py as a library to produce the report, using its text output. Parse the output and print a pretty report.


### config.json
* NOTE: may be security sensitive due to storing AWS credentials.
* JSON format configuration file for network definitions, AWS credentials, nmap options, reporting email addresses etc.

### networks.json
Cache file created by spongebob.py. Contains a dict: key: network description or AWS account name, value: list of IP addresses or CIDR network specs.

# TODO
* tweak multiprocessing processes param, currently 1/cpu (default)
* objectify and iteratize
